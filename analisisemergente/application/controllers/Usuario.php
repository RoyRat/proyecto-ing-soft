<?phpclass Usuario extends CI_Controller{    public function __construct() {        parent::__construct();        $this->load->model('musuario');        $this->load->model('mvarios');    }           function index(){            $datos['aprobador']=$this->session->userdata('US_ADMINISTRADOR');			$datos['usuario']=$this->session->userdata('US_USUARIO');			$datos['sistemas']=$this->session->userdata('US_ADMSISTEMAS');            $this->load->view("usuario/js/index_usr_js",$datos);            $this->load->view("usuario/index_usr_v",$datos);        }                function getdatosItems(){            echo  $this->musuario->getdatosItems();        }     		function getSistemasUser(){          echo $this->musuario->getSistemasUser();      }	 	//funcion para cear una nueva lista	public function nuevoUsuario(){                 $datos=$this->datos(null,'n');            $datos['accion'] = 'n';            $this->load->view("usuario/usuario_v",$datos);            $this->load->view("usuario/js/usuario_js",$datos);        }                //funcion para ver la informacion de un registro        function verUsuario($accion=null){            $numero=  $this->input->post('NUMERO');            if(!empty($numero)){                $sol = $this->musuario->dataRegistro($numero);                      $USER=$this->session->userdata('US_CODIGO');                      if ($accion=='v'|$accion=='e'|$accion=='x'|$accion=='d'){                            $datos=$this->datos($sol,$accion);                            $datos['sol']=$sol;                            $datos['accion'] = $accion;                            $this->load->view("usuario/usuario_v",$datos);                            $this->load->view("usuario/js/usuario_js",$datos);                      } else {                            echo alerta("La acci贸n no es reconocida");                      }            }else{                echo alerta("No se puede mostrar el formulario, debe seleccionar un registro para continuar.");            }        }              	//funcion para dar los valores a la cabecera tanto en nuevo, como al momento de editar	function datos($sol,$accion){        if ($accion=='n') {			//Caso para nueva persona				$datos['combo_pais']= $this->mvarios->cmb_pais(null,"id='LOC_PAIS' style='width:150px;'");				$datos['combo_provincia']=$this->mvarios->cmb_provincia(null,null," style='width:150px;' id='LOC_PROVINCIA'");				$datos['combo_ciudad']=$this->mvarios->cmb_ciudad(null,null," style='width:150px;' id='LOC_CIUDAD'");				$datos['combo_sector']=$this->mvarios->cmb_sector(null,null," style='width:150px;' id='LOC_SECTOR'");        } else {							//Caso para la edici贸n de una persona				$LOC_SECTOR=$sol->US_LOCALIZACION;				$LOC_CIUDAD=$this->ciudad($LOC_SECTOR);				$LOC_PROVINCIA=$this->provincia($LOC_CIUDAD);				$LOC_PAIS=$this->pais($LOC_PROVINCIA);																$datos['combo_pais'] = $this->mvarios->cmb_pais($LOC_PAIS,"id='LOC_PAIS' style='width:150px; height:25px;' class='selectpicker' data-style='btn-success'");				$datos['combo_provincia']=$this->mvarios->cmb_provincia($LOC_PROVINCIA,$LOC_PAIS," style='width:150px;' id='LOC_PROVINCIA'");				$datos['combo_ciudad']=$this->mvarios->cmb_ciudad($LOC_CIUDAD,$LOC_PROVINCIA," style='width:150px;' id='LOC_CIUDAD'");				$datos['combo_sector']=$this->mvarios->cmb_sector($LOC_SECTOR,$LOC_CIUDAD," style='width:150px;' id='LOC_SECTOR'");        }        return($datos);     }	 	 function pais($provincia){			$SQL="select LOC_PREDECESOR FROM LOCALIZACION 			where LOC_NIVEL=2 			AND LOC_ESTADO=0 			AND LOC_SECUENCIAL=$provincia";			$pais=$this->db->query($SQL)->row()->LOC_PREDECESOR;			return $pais;		}				function provincia($ciudad){			$SQL="select LOC_PREDECESOR FROM LOCALIZACION 			where LOC_NIVEL=3 			AND LOC_ESTADO=0 			AND LOC_SECUENCIAL=$ciudad";			$provincia=$this->db->query($SQL)->row()->LOC_PREDECESOR;			return $provincia;		}				function ciudad($sector){			$SQL="select LOC_PREDECESOR FROM LOCALIZACION 			where LOC_NIVEL=4 			AND LOC_ESTADO=0 			AND LOC_SECUENCIAL=$sector";			$ciudad=$this->db->query($SQL)->row()->LOC_PREDECESOR;			return $ciudad;		}	     	//Administra las foncuiones de nuevo y editar en un registro    function admUsuario($accion){        switch($accion){            case 'n':                echo $this->musuario->addUsuario();                break;            case 'e':                echo $this->musuario->editUsuario();                break;        }            }    	//Cambia de estado a pasivo a un usuario    function anularUsuario(){         $US_SECUENCIAL=$this->input->post('NUMERO');            $SQL="update USUARIO set US_ESTADO=1 where US_SECUENCIAL=$US_SECUENCIAL";             $this->db->query($SQL);            echo json_encode(array("cod"=>1,"mensaje"=>highlight("Usuario ".$US_SECUENCIAL." Anulado")));     }		//Cambia de estado a activo a un usuario    function activarUsuario(){         $US_SECUENCIAL=$this->input->post('NUMERO');            $SQL="update USUARIO set US_ESTADO=0 where US_SECUENCIAL=$US_SECUENCIAL";             $this->db->query($SQL);            echo json_encode(array("cod"=>1,"mensaje"=>highlight("Usuario ".$US_SECUENCIAL." Activado")));     }		//Resetear Clave de usuario		public function errorSeleccion(){            echo highlight("Debe seleccionar un item del listado para continuar.");        }			public function resetclave(){		$US_SECUENCIAL = $_POST['US_SECUENCIAL'];		$sqlfecha="select DATE_FORMAT(SYSDATE(),'%d/%m/%Y %H:%i:%s') FECHA from dual";		$FECHA=$this->db->query($sqlfecha)->row()->FECHA;		$US_FECHAACTUAL="STR_TO_DATE('".$FECHA."','%d/%m/%Y %H:%i:%s')";				$clave=encriptar('1234');		$US_MAIL=$_POST['US_SECUENCIAL'];			if(!empty($US_SECUENCIAL) and $US_SECUENCIAL!= null){				$user=$US_SECUENCIAL;				}else{				$user=utf8_decode($_POST['US_SECUENCIAL']);			}			$this->load->model('mcorreo');			$usuario=$this->mvarios->VerificarCorreo($user);			if($usuario==0){				$USERCON=$this->db->query("SELECT * FROM USUARIO WHERE US_MAIL='$US_MAIL'")->row();				if(!empty($USERCON) and ($USERCON!=null)){					$correoFuncion=$this->mcorreo->mailReset($USERCON->US_SECUENCIAL,1);					//$correoFuncion=$this->mcorreo->mailPrueba();					if($correoFuncion==1){						$this->db->query("UPDATE USUARIO SET US_FECHACAMBIO=$US_FECHAACTUAL,US_CLAVE = '$clave' 																	WHERE US_SECUENCIAL=".$USERCON->US_SECUENCIAL."");						echo success("Clave de usuario, reseteada correctamente");						}else{						echo alerta($correoFuncion);					}					}else{					echo alerta("C贸digo No Se Encuentra Registrado");				}				}else{				$USERCOD=$this->db->query("SELECT * FROM USUARIO WHERE US_SECUENCIAL=$user")->row();				if(!empty($USERCOD) and ($USERCOD!=null)){					$correoFuncion=$this->mcorreo->mailReset($user,1);					//$correoFuncion=$this->mcorreo->mailPrueba();					if($correoFuncion==1){						$this->db->query("UPDATE USUARIO SET US_FECHACAMBIO=$US_FECHAACTUAL,US_CLAVE = '$clave' WHERE US_SECUENCIAL=".$user."");						echo success("Clave de usuario, reseteada correctamente");						}else{						echo alerta($correoFuncion);					}					}else{					echo alerta("C贸digo No Se Encuentra Registrado");				}			}        }function mostrarformularioReset($US_CODIGO,$FECHA){                $sql="select US_CODIGO,US_NOMBRES,							DATEDIFF(DATE_ADD(STR_TO_DATE('$FECHA','%d/%m/%Y %H:%i:%s'),INTERVAL 1 DAY),NOW()) DIA					  FROM USUARIO WHERE US_CODIGO='$US_CODIGO'";                $datos=  $this->db->query($sql)->row_array();                if ($datos['DIA']>=0) {                    $datos['cambiopassword']=1;                    $this->load->view("general/cabecera");                    $this->load->view('usuario/frm_div_v');                    $this->load->view('usuario/usu_frmPass',$datos);                } else {                    $msj="El Enlace ha Caducado, Realize un Nuevo Pedido de Reseteo";                    $data['msj'] = $msj;                    $data['image'] = "DENRED";					$this->load->view("general/cabecera");                    $this->load->view("general/dialog_mensaje",$data,false);                }                          }				function ruta($urlEncoded){          $function = explode("--",base64_decode(urldecode($urlEncoded)));  	  echo $this->$function[0]($function[1],$function[2]);      }function GrbFrmPrtPass(){         $this->musuario->GrbFrmPrtPass();      }	  //Usuario Aplicacionfunction indexusuariosSistema(){        $datos['sistema']=$this->input->post('sistema');        $datos['NombreDialog']=  $this->input->post('NombreDialog');        $this->load->view('usuario/indexusuariosSistema_v',$datos);    }function  getUsuariosSistema(){        echo $this->musuario-> getUsuariosSistema();    }function indexuseraplicacion($accion){        $user = $this->input->post('US_SECUENCIAL');		if(!empty($user) and $user!=NULL){        if ($accion=='n'){		$sql="select * FROM USUARIO WHERE US_SECUENCIAL= '$user'";            $usuario=  $this->db->query($sql)->row();			            $datos['US_NOMBRES']=  $usuario->US_NOMBRES;            $datos['ACC_SEC_USUARIO']= $usuario->US_SECUENCIAL;            $datos['cmbapp']=$this->musuario->cmbapp(0,$user,"style='width:200px;' id='ACC_SEC_APLICACION' tabindex=275","ACC_SEC_APLICACION");            $datos['cmbperfil']= $this->musuario->cmbperfil(null,null,"style='width:200px;' id='ACC_SEC_ROLES'","ACC_SEC_ROLES");            $datos['accion']='n';			$this->load->view('usuario/useraplicacion_v',$datos);        } else {			$sec=$this->input->post('ACC_SECUENCIAL');            if(!empty($sec) and $sec!=NULL){						$datos = $this->db->query("select * from ACCESO where ACC_SECUENCIAL=$sec")->row_array();            $usuario=  $this->db->query("select * FROM USUARIO WHERE US_SECUENCIAL=".($user)."")->row();            $datos['US_NOMBRES'] =  $usuario->US_NOMBRES;            $datos['cmbapp']=$this->musuario->cmbapp($datos['ACC_SEC_APLICACION'],$user,"style='width:200px;' id='ACC_SEC_APLICACION' tabindex=250","ACC_SEC_APLICACION");            $datos['cmbperfil']= $this->musuario->cmbperfil($datos['ACC_SEC_APLICACION'],$datos['ACC_SEC_ROLES'],"style='width:200px;' id='ACC_SEC_ROLES'","ACC_SEC_ROLES");            $datos['accion']='e';			$this->load->view('usuario/useraplicacion_v',$datos);			}else{				echo alerta("No se puede mostrar el formulario, debe seleccionar un registro para continuar.");			}        } 		}else{			echo alerta("El usuario seleccionado no puede estar sin CODIGO...");		}    }function get_roles(){        $aplicacion=$this->input->post('aplicacion');		if(!empty($aplicacion)){        $output = "";        $query = $this->db->query("select USR_SECUENCIAL,USR_DESCRIPCION 									from ROLES 									where USR_ESTADO<>1									and USR_SEC_APLICACION=(SELECT APP_SECUENCIAL 																FROM APLICACION 																WHERE APP_SECUENCIAL=$aplicacion)");        $results = $query->result();        $output .='<option value="">Seleccion..</option>';        foreach ($results as $result):                $output .="<option value="."'".$result->USR_SECUENCIAL."'".">".($result->USR_DESCRIPCION)."</option>";        endforeach;        echo $output;		}else{			$output = "";			$output .='<option value="">Seleccion..</option>';			echo $output;		}   } function addappuser(){            echo $this->musuario->addappuser();        }         function editappuser(){            echo $this->musuario->editappuser();        }     function delappuser(){       $SEC=  $this->input->post('sec');            $sql="update ACCESO set ACC_ESTADO=1 where ACC_SECUENCIAL=".$SEC;            $this->db->query($sql);            $output['cod'] = 1;            $output['mensaje'] = ('Se ha bloqueado la aplicacion');            echo json_encode($output);   }    function actappuser(){       $SEC=  $this->input->post('sec');         $sql="update ACCESO set ACC_ESTADO=0 where ACC_SECUENCIAL=".$SEC;              $this->db->query($sql);               $output['cod'] = 1;            $output['mensaje'] = ('Se ha habilitado la aplicacion');            echo json_encode($output);   }  }?>